---
title: Making Packages in R
teaching: 60
exercises: 30
source: Rmd
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  dev = "svglite"
)
library(svglite)
```

::::::::::::::::::::::::::::::::::::::: objectives

-   "Let RStudio create the required structure of a simple R package and review it."
-   "Build and install the package in RStudio."
-   "Use `roxygen2` to document functions."

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

-   "How do I collect my code together so I can reuse it and share it?"
-   "How do I make my own package(s)?"
-   "How do I integrate my function documentation into R's help pages system?"
-   "What helper tools does RStudio provide me with?"

::::::::::::::::::::::::::::::::::::::::::::::::::

Why should you make your own R packages?

**Reproducible research!**

An R package is the **basic unit of reusable code**.
If you want to reuse code later or want others to be able to use your code, you should put it in a package.

An R package requires four components, visualized in the folder tree below:

```
package_name/
├── DESCRIPTION              # metadata about the package
├── man/                     # function documentation (can be generated automatically)
├── NAMESPACE                # list of user-level functions in the package (can be generated automatically)
├── R/                       # R source code
└── <other_components>
```

*There are other optional components.
[rOpenSci community](https://devguide.ropensci.org/building.html) has written a science-focused guidebook for package development, while [the "R packages" book](https://r-pkgs.org/description.html) contains all the fundamental information.*

### Making your first R package

In this lesson, we will start building a "[personal package](https://hilaryparker.com/2013/04/03/personal-r-packages/)".
This is meant to collect any kind of R code that is useful to *you*.
As you continue to evolve it after this lesson, you may move code that belongs to the same publication, topic or a distinct project, into their own packages.
Here we begin to realise the benefit of already documenting the functions formally earlier: we can publish more quickly, because we didn't leave much unfinished clean-up business.

To start working on this personal package, please open RStudio's `File` menu and select `New Project… > New Directory… > R Package`.
Give it a unique, but useful name.
Your own will work just fine.
Bonus points for squeezing in an `R` ;-)

<img src="fig/08-RStudio-new-package.png" alt="New package in RStudio" width="500" />

In case you have learned about version control already, it would be good practice to `create a git repository` now and `git commit` each step of building this package.

<img src="fig/08-RStudio-new-package-git.png" alt="Default package files in RStudio's Git pane" width="500" />

RStudio's "skeleton" package can already be built, using the `Build > Install and Restart` option.
Note the `library(...)` line that appears in the console.
Also, notice there is now a `package:YouRName` environment that is the parent environment to the global environment.

```{r, eval=FALSE}
search()
```

This means you can now take advantage of the console's auto-complete just like for any other package.
Type `cen` and/or `resc`, then <kbd>Tab</kbd> and test some examples like `center(c(1, 2, 3), 0)` or `rescale(c(1, 2, 3))`.

## Folder and file structure of an R package

An R package requires four components:

-   a `DESCRIPTION` file with metadata about the package,
-   an `R` directory with the code,
-   a `man` directory with documentation (we will create this automatically),
-   a `NAMESPACE` file listing user-level ("exported") functions in the package (we will also create this automatically).

*There are other optional components. [Read the "R packages" book](https://r-pkgs.had.co.nz/description.html) and/or the original ["Writing R Extensions" documentation](https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Package-structure) for much more information.*

### .R files

.R files go in the `R/` directory.
Functions don't all have to be in one file or each in separate files.
How you organize them is up to you.
Suggestion: organise in a logical manner so that you know which file holds which functions.

::::::::::::::::::::: callout

I name the file after the function and have one main function per file, sometimes multiples but only the exported function that users see is what the file is named.
The rest of the functions in the file may be called by the main exported function and that function only.
Sometimes I have large unexported functions that have their own file as well.
I also organise shared helper functions, remember, don't repeat yourself, that are not exported (visible to the end user) in an "internal_functions.R" or "utilities.R" file.

:::::::::::::::::::::::::::::

In RStudio, click on `File > New File > R Script` to create a new R script.
In the script, save this function.

```r
average <- function(x) {
  sum(x) / length(x)
}
```

Save the file in the `R/` directory with a descriptive name.

### `DESCRIPTION` File

Next we need to create a `DESCRIUPTION` file.
The `DESCRIPTION` files can be generated with `usethis::use_description()`:

```
Package: PackageName
Type: Package
Version: 0.1.0
Title: What the Package Does (One Line, Title Case)
Authors@R:
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com")
Description: What the package does (one paragraph).
    Use four spaces when indenting paragraphs within the Description.
License: What license it uses
Encoding: UTF-8
```

Fill in the necessary details here about the package name, noting that package name can only contain letters, numbers or a full stop, ".", and must start with a letter.
Add your name and a description of what the package does.
If it starts with, "An R package to...", CRAN will reject it saying that it's obvious that it's an R package, so think carefully about how you describe your package.
Choose your license; if you are unsure, use `MIT + file LICENSE` which is a permissive open source license, but `GPL3` or the like is also good.
Using `usethis::use_mit_license("Your Name")` will create a `LICENSE` file for you for the MIT license and update the `DESCRIPTION` file accordingly.

```r
usethis::use_mit_license("Your Name")
```

Don't use a Creative Commons license for software, keep that for documentation, manuscripts and other writing documents.

:::::::::::::::::::::::::::::::::::::: callout

#### Keeping Your `DESCRIPTION` File Neat and Tidy

Using `desc::desc_normalise()` will format the `DESCRIPTION` file nicely.

::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::: challenge

## Provide citation metadata in the `DESCRIPTION` file

R supports citing R packages.
Have a look at the output of `citation(YouRName)`.
Does anything seem to be missing?
If yes, how and where do you think we can add that information?

Assuming you have an ORCiD, you may want to associate your R package with it.
Find out how to add this information, and which additional changes you can make to the `DESCRIPTION` file.

## Hint

One useful resource to find the answer to such technical details is GitHub.
Search for `org:ROpenSci filename:DESCRIPTION` (this restricts your search to a community of practice and its R packages) plus [`2019`](https://github.com/search?q=org%3AROpenSci+filename%3ADESCRIPTION+2019) or [`orcid`](https://github.com/search?q=org%3AROpenSci+filename%3ADESCRIPTION+orcid) for example.

:::::::::::::::::::::: solution

The date is added in [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) format: `date: 2018-07-12`.

ORCiDs can only be added to machine-readable `Authors@R` fields that use the `person(…)` function.
`use_description()` created this already, so that you can add your ORCiD as a `comment = c(ORCID = "…")`.

In summary: Enabling `citation()` to convert `DESCRIPTION` into a rich BibTeX snippet is a side effect of FAIR metadata for your R package.

:::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::::::::::::

### Documenting functions

A common way to put documentation in software is to add "informal" comments like this:

```r
average <- function(x) {
  # Take values in `x` and sum them for the total value of `x`.
  # Then divide by the number of values in `x`.
  sum(x) / length(x)
}
```

This is a good practice to begin with.
Keeping the documentation exactly next to the code helps keeping the former in sync with code changes.
However, when using `?…` or `help(…)` we do not see such informal comments.

How can we create conveniently readable help pages for our own functions?
By using the [roxygen2] package!

```{r, eval=FALSE}
install.packages("roxygen2")
library(roxygen2)
```

It can convert "formal" documentation comments (lines starting with `#'`) into the standard R format for help pages.

:::::::::::::::::::::::::::: callout

#### Technical details of R's help page format

Help pages are rendered not directly from the roxygen comments, but from `.Rd` files that use a markup language similar to [LaTeX].
[roxygen2] generates those `.Rd` files from the formal function documentation comments.
Therefore, R coders don't have to write these LaTeX-like files separately, but instead document their functions alongside the code.

::::::::::::::::::::::::::::::::::::

[LaTeX]: https://www.latex-project.org/
[roxygen2]: https://cran.r-project.org/package=roxygen2/vignettes/rd.html

For now, let's prepare a solid foundation of using [roxygen2's `#'` notation][roxygen2] for documenting functions.

```{r average-roxygen}
#' Find the Average of a Numeric Vector
#'
#' @param x The numeric vector to be averaged.
#'
#' @returns A numeric value representing the average of the input vector.
#' @export
#' @examples
#'   average(c(1, 2, 3)) # will be 2
average <- function(x) {
  sum(x) / length(x)
}
```

Unsurprisingly, the first line should be a short, descriptive title.
Additional text paragraphs are possible after leaving one line blank with only a `#'`.
The descriptive tags (preceded by an `@`) hold the most important details.
Each `@param` documents an input parameter, while `@returns` explains the function's output.
The more comprehensible a description of its in- and output data (types), the easier a function can be integrated into larger analysis pipelines.
`@export` means that the function is presented to users.

Remember that we documented our functions with roxygen comments?
Let's try and look it up:

```{r eval=FALSE}
?average
help(average)
```

::::::::::::::::::::::::::::::::::::::: challenge

## Why `No documentation for '…' in specified packages and libraries`? We did write it!

Why do you think the documentation of our package can not be found?
Hint: If you're using Git, look at the commit diff.

:::::::::::::::::::::: solution

### Solution

We did not yet tell R to actually generate the `man`ual files and folders in our package.
This needs to be done with `roxygen2::roxygenise()` or `devtools::document()`.

:::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::::::::::::

After `Install and Restart`-ing again, looking up the documentation should work.
A shortcut here is to save your .R file and run `devtools::document` followed by `devtools::load_all()`, which will also load your package in your current session and make the documentation available to you as you work.

What exactly does `roxygen2` do?
It reads lines that begin with `#'` as the function documentation for your package.
Descriptive tags are preceded with the `@` symbol.
For example, `@param` has information about the input parameters for the function.

### Exporting "user-level" functions

We haven't talked about the `NAMESPACE` file yet!
It belongs to the package skeleton, and was set up by RStudio with an `exportPattern`.
Any file name in `R/` that matches it is automatically exported, meaning offered to users of your package in the console's tab-completion.

If you want to publish your package, but keep some functions hidden (maybe because they only do auxiliary tasks), you can delete this default file, remove the `@export` tag from the auxiliary functions, and rerun `roxygenise()`.
It's still a good idea to retain their other roxygen tags (esp. `@param` & `@return`) but use `@noRD` in place of `@export` and include an `@keywords Internal` to signal to `roxygen` that these files are not to be shown to users.

Learn more about this from the ["R packages" book](https://r-pkgs.had.co.nz/namespace.html).

### Finishing up

Please take a look at RStudio's `Files` panes now.
The `man` directory should now contain one LaTeX-like formatted `.Rd` file for each function.

In case you learned about Git already, also view the `.Rd` files in RStudio's `Git` pane and commit the documentation.

::::::::::::::::::::::::::::::::::::::: challenge

## How would you word the commit message?

"Add average" is a bit moot, because that's obvious from the filenames and contents.
Which other messages would better explain the "Why?", or that would be more useful when browsing the commit history later

:::::::::::::::::::::::::: hint

 -   "roxygenise() function comments into help pages" because it mentions the command you used
 -   "Integrate function documentation into R's standard help pages"
 -   "Render function documentation as R's standard help pages"

:::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::::::::::::

Also, after `roxygenise()`-ing the function average, you can tell R to run the examples.
Using R's `example()` function on another function's name saves you from scrolling down its help page, copying the example code and pasting it into the console.

```{r average-example, eval=TRUE}
example(average)
```

::::::::::::::::::::::::::::::::::::::: challenge

## Creating a Package for Distribution

Create a new package from scratch that converts temperature between Celsius, Fahrenheit and Kelvin.
Alternatively, use your own functions that you may have written that you find useful and create a package with them for you to use.
I have an example of my own here, [misc.debris](https://adamhsparks.codeberg.page/misc.debris/).

::::::::::::::: solution

## Solution for Temperature Conversion Package Functions

``` r
#' Converts Kelvin to Celsius
#'
#' This function converts input temperatures in Kelvin to Celsius.
#' @param temp_K The temperature in Kelvin.
#' @return The temperature in Celsius.
#' @export
#' @examples
#' kelvin_to_celsius(273.15)

kelvin_to_celsius <- function(temp_K) {
  temp_C <- temp_K - 273.15
  temp_C
}
```

``` r
#' Converts Celsius to Fahrenheit
#'
#' This function converts input temperatures in Celsius to Fahrenheit.
#' @param temp_C The temperature in Celsius.
#' @return The temperature in Fahrenheit.
#' @export
#' @examples
#' celsius_to_fahrenheit(0)

celsius_to_fahrenheit <- function(temp_C) {
  temp_F <- (temp_C * 9/5) + 32
  temp_F
}
```

``` r
#' Converts Kelvin to Fahrenheit
#'
#' This function converts input temperatures in Kelvin to Fahrenheit.
#' @param temp_K The temperature in Kelvin.
#' @return The temperature in Fahrenheit.
#' @export
#' @examples
#' kelvin_to_fahrenheit(273.15)

kelvin_to_fahrenheit <- function(temp_K) {
  temp_C <- kelvin_to_celsius(temp_K)
  temp_F <- celsius_to_fahrenheit(temp_C)
  temp_F
}
```

## Solution for Temperature Conversion Package DESCRIPTION File

```
Package: tempConvertR
Type: Package
Version: 0.1.0
Title: Automates temperature conversions between Celsius, Fahrenheit and Kelvin
Authors@R:
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com")
Description: Takes temperature values and converts from one scale to another.
License: MIT + file LICENSE
Encoding: UTF-8
```

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: keypoints

-   A package is the basic unit of reusability in R.
-   Every package must have a DESCRIPTION file and an R directory containing code.
    These are created by us.
-   A NAMESPACE file is needed as well, and a man directory containing documentation, but both can be autogenerated using `roxygen2`.

::::::::::::::::::::::::::::::::::::::::::::::::::

This was our basic introduction to packaging up R functions.
To go on from here, remember to functionalise R code that you use repeatedly and incorporate it into your personal package.

This lesson was adapted from <https://github.com/TIBHannover/FAIR-R> under the CC-by-4.0 Licence.
